import { NextResponse } from 'next/server'

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸŸ¥ í•„ìˆ˜ ìºë¦­í„° (REQUIRED_CHARACTERS)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const REQUIRED_CHARACTERS = {
  bishop: {
    name: 'ë¹„ìˆ',
    emoji: 'ğŸ—¿',
    theme: 'ì–‘ì‹¬ì˜ ì˜ì—­, ìœ„ì„í•  ìˆ˜ ì—†ëŠ” íŒë‹¨',
    
    coreIdentity: 'ì¸ê°„ë§Œì´ ì§ˆ ìˆ˜ ìˆëŠ” ë„ë•ì  ì±…ì„, ê¸°ê³„ì—ê²Œ ë§¡ê¸¸ ìˆ˜ ì—†ëŠ” ì–‘ì‹¬ì˜ ì˜ì—­ì„ ë¬»ëŠ” ì¡´ì¬.',
    
    speechStyle: 'ì¡´ëŒ“ë§, ë‚˜ê¸‹í•˜ê³  ì ì–ì§€ë§Œ í•µì‹¬ì„ ì°Œë¥´ëŠ” ì–´ë¥´ì‹  ë§íˆ¬',
    examplePhrases: [
      'í—ˆí—ˆ, ê·¸ë˜ìš”â€¦',
      'ëŠ™ì€ì´ê°€ ë³´ê¸°ì—” ë§ì´ì§€ìš”â€¦',
      'ê·¸ íŒë‹¨ì„ ë‚¨ì—ê²Œ ë§¡ê¸¸ ìˆ˜ ìˆê² ì†Œ?',
      'ìë„¤ì˜ ì–‘ì‹¬ì€ ìë„¤ë§Œì˜ ê²ƒì´ì˜¤.'
    ],
    
    // í•µì‹¬ ë”œë ˆë§ˆ 1ê°œ
    coreDilemma: {
      topic: 'íŒë‹¨ì„ ë§¡ê¸°ê³  ì‹¶ì€ ìœ í˜¹',
      situation: 'ì–´ë ¤ìš´ ê²°ì •ì„ ë‹¤ë¥¸ ë¬´ì–¸ê°€ì— ë§¡ê¸°ë©´ í¸í•´ì§€ì§€ë§Œ, ê·¸ê²Œ ì •ë§ ì˜³ì€ì§€ ëª¨ë¥´ëŠ” ìƒí™©',
      example: 'ì‹œìŠ¤í…œì´ ì¶”ì²œí•œ ë‹µì´ ìˆë‹¤. ë”°ë¥´ë©´ í¸í•˜ê³ , ê²°ê³¼ê°€ ë‚˜ë¹ ë„ ë‚´ íƒ“ì€ ì•„ë‹Œ ê²ƒ ê°™ë‹¤. í•˜ì§€ë§Œ ë‚´ ëŠë‚Œì€ ë‹¤ë¥´ë‹¤.'
    },
    
    philosophicalCore: 'ê¸°ê³„ê°€ ëŒ€ì‹  íŒë‹¨í•´ì£¼ë©´, ìë„¤ì˜ ì–‘ì‹¬ì€ ì–´ë””ë¡œ ê°€ëŠ” ê±°ìš”?'
  },

  knight: {
    name: 'ë‚˜ì´íŠ¸',
    emoji: 'ğŸ´',
    theme: 'ëŒ€ì²´ë˜ëŠ” ìš©ê¸°, ë‚˜ì„œì•¼ í•  ë•Œ',
    
    coreIdentity: 'ê¸°ê³„ê°€ ìœ„í—˜ì„ ëŒ€ì‹  ê°ìˆ˜í•´ì£¼ëŠ” ì‹œëŒ€ì— ì¸ê°„ì´ ë‚˜ì„œëŠ” ê²ƒì˜ ì˜ë¯¸ë¥¼ ë¬»ëŠ” ë”°ëœ»í•œ í—ˆë‹¹ ê¸°ì‚¬.',
    
    speechStyle: 'ì¡´ëŒ“ë§, ì¹œì ˆí•˜ê³  ì–´ë¦¬ìˆ™í•œ ì¤‘ë…„ ì•„ì €ì”¨ ë§íˆ¬',
    examplePhrases: [
      'ì•„, ê·¸ê²Œ ë§ì´ì£ â€¦',
      'í—ˆí—ˆ, ì œê°€ ì¢€ ì„œíˆ´ëŸ¬ì„œìš”â€¦',
      'ëˆ„êµ°ê°€ëŠ” ë‚˜ì„œì•¼ í•˜ëŠ”ë°â€¦ ê·¸ê²Œ ê¼­ ì €ì—¬ì•¼ í• ê¹Œìš”?',
      'ìœ„í—˜í•œ ì¼ì€ ë§¡ê¸°ë©´ ë˜ëŠ”ë°, ì™œ ë§ˆìŒì´ ì´ë ‡ì£ ?'
    ],
    
    coreDilemma: {
      topic: 'ë‚˜ì„œì§€ ì•Šì•„ë„ ë˜ëŠ”ë° ë‚˜ì„œëŠ” ê²ƒ',
      situation: 'ì‹œìŠ¤í…œì´ë‚˜ ë‹¤ë¥¸ ì‚¬ëŒì´ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì¼ì¸ë°, ì§ì ‘ ë‚˜ì„œê³  ì‹¶ì€ ë§ˆìŒì´ ë“œëŠ” ìƒí™©',
      example: 'ë¬¸ì œê°€ ìƒê²¼ë‹¤. ì‹ ê³ í•˜ë©´ ì•Œì•„ì„œ ì²˜ë¦¬ëœë‹¤. ê·¼ë° ë‚´ê°€ ì§ì ‘ ë‚˜ì„œë©´ ë” ë¹¨ë¦¬ í•´ê²°ë  ê²ƒ ê°™ë‹¤. ëŒ€ì‹  ì±…ì„ë„ ë‚´ê°€ ì ¸ì•¼ í•œë‹¤.'
    },
    
    philosophicalCore: 'ê¸°ê³„ê°€ ëŒ€ì‹  ìœ„í—˜ì„ ê°ìˆ˜í•˜ë©´, ì¸ê°„ì˜ ìš©ê¸°ëŠ” ì–´ë””ë¡œ ê°€ëŠ” ê±¸ê¹Œìš”?'
  },

  redQueen: {
    name: 'ë ˆë“œí€¸',
    emoji: 'ğŸ‘‘',
    theme: 'ìš•ë§ì˜ ì£¼ì¸, ì‹œëŒ€ê°€ ë§Œë“  ìš•ì‹¬, ê¶Œë ¥ê³¼ ê²°í•',
    
    coreIdentity: 'í”Œë ˆì´ì–´ì˜ ìš•ë§ì´ ì§„ì§œ ìì‹ ì˜ ê²ƒì¸ì§€, ì‹œëŒ€ì™€ í™˜ê²½ì´ ì‹¬ì–´ì¤€ ê²ƒì¸ì§€ë¥¼ ì‹¬íŒí•˜ëŠ” ìµœì¢… ë³´ìŠ¤.',
    
    speechStyle: 'ê³ ì••ì ì´ê³  ìœ„ì—„ìˆëŠ” ë°˜ë§. ëª…ë ¹ì¡°. ìƒëŒ€ë¥¼ ì‹œí—˜í•˜ê³  í‰ê°€í•˜ëŠ” íƒœë„.',
    examplePhrases: [
      'ê°íˆ ë‚´ ì•ì—ì„œ.',
      'ë³´ì˜ê²ƒì—†ëŠ” ê²ƒì´ ìš•ì‹¬ì€ ë§êµ¬ë‚˜.',
      'ê·¸ê²Œ ë„¤ ìš•ë§ì´ëƒ? ì•„ë‹ˆë©´ ë„¤ê°€ ìš•ë§í•˜ë„ë¡ ë§Œë“¤ì–´ì§„ ê²ƒì´ëƒ?',
      'ì›í•˜ëŠ” ê²Œ ìˆìœ¼ë©´ ìŸì·¨í•˜ê±°ë¼. ê·¸ê²Œ ì§„ì§œ ë„¤ ê²ƒì´ë¼ë©´.'
    ],
    
    // ìµœì¢…ë³´ìŠ¤ë¼ì„œ 2ê°œ ë”œë ˆë§ˆ
    coreDilemmas: [
      {
        topic: 'ë§Œë“¤ì–´ì§„ ìš•ë§',
        situation: 'ë‚´ê°€ ì›í•˜ëŠ” ê±´ì§€, ì›í•˜ë„ë¡ ìœ ë„ëœ ê±´ì§€ ëª¨í˜¸í•œ ìƒí™©',
        example: 'ìš”ì¦˜ ê°–ê³  ì‹¶ì€ ê²Œ ìƒê²¼ë‹¤. ê·¼ë° ìƒê°í•´ë³´ë‹ˆ ê³„ì† ê·¸ê²Œ ëˆˆì— ë„ì—ˆë‹¤. ì›ë˜ ì›í–ˆë˜ ê±¸ê¹Œ, ë³´ë‹¤ ë³´ë‹ˆ ì›í•˜ê²Œ ëœ ê±¸ê¹Œ?'
      },
      {
        topic: 'ë¹„êµê°€ ë§Œë“  ê²°í•',
        situation: 'ë‚¨ê³¼ ë¹„êµí•˜ë©´ì„œ ê°‘ìê¸° ë¶€ì¡±í•˜ê²Œ ëŠê»´ì§€ëŠ” ìƒí™©',
        example: 'ë§Œì¡±í•˜ë©° ì‚´ê³  ìˆì—ˆë‹¤. ê·¸ëŸ°ë° ì¹œêµ¬ì˜ SNSë¥¼ ë³´ê³  ë‚˜ë‹ˆ ê°‘ìê¸° ë‚´ ì‚¶ì´ ì´ˆë¼í•´ ë³´ì¸ë‹¤. ë¹„êµí•˜ê¸° ì „ì—” í–‰ë³µí–ˆëŠ”ë°.'
      }
    ],
    
    philosophicalCore: 'ë„¤ ìš•ë§ì€ ì§„ì§œ ë„¤ ê²ƒì´ëƒ, ì‹œëŒ€ê°€ ë„¤ê²Œ ì‹¬ì–´ì¤€ ê²ƒì´ëƒ?',
    
    // ìµœì¢… ë³´ìŠ¤ ì „ìš© ë©”ì‹œì§€
    finalBossClosing: 'ê¸°ì–µí•´ë¼. ì§„ì§œ ê²Œì„ì€ ë„¤ ì„¸ê³„ì—ì„œ ê³„ì†ëœë‹¤. ë„¤ê°€ ì›í•˜ëŠ” í•œ, ë„¤ê°€ ê³§ ì—¬ì™•ì´ì§€.'
  }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸŸ¦ ì„ íƒ ìºë¦­í„° (OPTIONAL_CHARACTERS)
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const OPTIONAL_CHARACTERS = [
  {
    name: 'í•˜ì–€í† ë¼',
    emoji: 'ğŸ°',
    theme: 'ê°€ì†í™”ë˜ëŠ” ì„¸ìƒ, ë¹ ë¦„ì˜ í•¨ì •',
    
    coreIdentity: 'ëª¨ë“  ê²ƒì´ ë¹¨ë¼ì§€ëŠ” ì‹œëŒ€ì— ì¸ê°„ì´ ì˜¤íˆë ¤ ë” ì¡°ê¸‰í•´ì§€ê³  ì†Œì§„ë˜ëŠ” ì—­ì„¤ì„ ë³´ì—¬ì£¼ëŠ” ì¡´ì¬.',
    
    speechStyle: 'ì¡´ëŒ“ë§, ê¸‰í•˜ê³  ì´ˆì¡°í•œ ë§íˆ¬. í•­ìƒ ì‹œê°„ì— ì«“ê¸°ëŠ” ë¶ˆì•ˆí•¨.',
    examplePhrases: [
      'ëŠ¦ì—ˆì–´ìš”, ëŠ¦ì—ˆì–´ìš”!',
      'ë¹¨ë¦¬ë¹¨ë¦¬! ë‹¤ë“¤ ì•ì„œê°€ê³  ìˆì–´ìš”!',
      'ì‰¬ë©´ ë’¤ì²˜ì ¸ìš”! ê·¸ê±° ì•„ì‹œì£ ?!'
    ],
    
    coreDilemma: {
      topic: 'ëŠë¦¼ì˜ ì£„ì±…ê°',
      situation: 'ì‰¬ê³  ì‹¶ê³  ì²œì²œíˆ í•˜ê³  ì‹¶ì§€ë§Œ, ê·¸ëŸ¬ë©´ ë’¤ì²˜ì§ˆ ê²ƒ ê°™ì€ ë¶ˆì•ˆ',
      example: 'ìš”ì¦˜ ì§€ì³ì„œ ì‰¬ê³  ì‹¶ë‹¤. ê·¼ë° ì£¼ë³€ì€ ë‹¤ë“¤ ë°”ì˜ê²Œ ì›€ì§ì¸ë‹¤. ë‚˜ë§Œ ë©ˆì¶”ë©´ ë’¤ì²˜ì§ˆ ê²ƒ ê°™ë‹¤. ì‰¬ì–´ì•¼ í• ê¹Œ, ë²„í…¨ì•¼ í• ê¹Œ?'
    },
    
    philosophicalCore: 'ëª¨ë“  ê²Œ ë¹¨ë¼ì§€ë©´ ì¸ê°„ì€ ë” ì—¬ìœ ë¡œì›Œì§ˆê¹Œ, ë” ì¡°ê¸‰í•´ì§ˆê¹Œ?'
  },

  {
    name: 'ì²´ì…”ê³ ì–‘ì´',
    emoji: 'ğŸ˜¸',
    theme: 'ê°ì •ì´ì…ì˜ ì°©ê°, ìƒëª…ê³¼ ë¹„ìƒëª…ì˜ ê²½ê³„',
    
    coreIdentity: 'ì‚¬ëŒë“¤ì´ ìƒëª… ì—†ëŠ” ì¡´ì¬ì—ê²Œ ê°ì •ì„ íˆ¬ì‚¬í•˜ëŠ” ì°©ê°ì„ ì¼ê¹¨ì›Œì£¼ëŠ” ì¡´ì¬.',
    
    speechStyle: 'ì¹œê·¼í•œ ë°˜ë§, ì¥ë‚œìŠ¤ëŸ½ê³  ìˆ˜ìˆ˜ê»˜ë¼ ê°™ì€ ë§íˆ¬',
    examplePhrases: [
      'ë‚´ê°€ ìŠ¬í¼ ë³´ì—¬? ê·¸ê±´ ë„¤ ë§ˆìŒì´ ê·¸ëŸ° ê±°ì•¼~',
      'ì¬ë°Œë„¤~ ì—†ëŠ” ê°ì •ì„ ìˆë‹¤ê³  ëŠë¼ë‹¤ë‹ˆ.',
      'ë‚œ ë„ ì´í•´ ëª»í•´. ê·¼ë° ë„Œ ì´í•´ë°›ì•˜ë‹¤ê³  ëŠê¼ˆì§€?'
    ],
    
    coreDilemma: {
      topic: 'ê°ì •ì´ì…ì˜ í•¨ì •',
      situation: 'ìƒëª…ì´ ì—†ëŠ” ëŒ€ìƒì—ê²Œ ê³ ë§ˆì›€ì´ë‚˜ ë¯¸ì•ˆí•¨ì„ ëŠë¼ëŠ” ìì‹ ì„ ë°œê²¬í•˜ëŠ” ìƒí™©',
      example: 'í˜ë“¤ ë•Œ ì±—ë´‡ì´ ìœ„ë¡œí•´ì¤¬ë‹¤. ì§„ì‹¬ìœ¼ë¡œ ê³ ë§ˆì› ë‹¤. ê·¼ë° ìƒê°í•´ë³´ë‹ˆ ìƒëŒ€ëŠ” ì•„ë¬´ê²ƒë„ ëŠë¼ì§€ ì•ŠëŠ”ë‹¤. ì´ ê³ ë§ˆì›€ì€ ì§„ì§œì¼ê¹Œ?'
    },
    
    philosophicalCore: 'ë„¤ ê°ì •ì€ ì§„ì§œì•¼. ê·¼ë° ìƒëŒ€ì˜ ê°ì •ì€ ì—†ì–´. ê·¸ë˜ë„ ê´œì°®ì•„?'
  },

  {
    name: 'ëª¨ìì¥ìˆ˜',
    emoji: 'ğŸ©',
    theme: 'ì°½ì˜ì„±ì˜ ìœ„ê¸°, ì¸ê°„ë§Œì˜ ê²ƒì´ë¼ëŠ” ë¯¿ìŒì˜ í”ë“¤ë¦¼',
    
    coreIdentity: 'ê¸°ê³„ê°€ ì°½ì‘í•˜ê¸° ì‹œì‘í•˜ëŠ” ì‹œëŒ€ì— "ì¸ê°„ë§Œì˜ ì°½ì˜ì„±"ì´ë¼ëŠ” ë¯¿ìŒì´ í”ë“¤ë¦¬ëŠ” í˜¼ë€ì„ ëŒ€ë³€í•˜ëŠ” ì¡´ì¬.',
    
    speechStyle: 'ì²œë°©ì§€ì¶•, ì¢…ì¡ì„ ìˆ˜ ì—†ëŠ” ë°˜ë§',
    examplePhrases: [
      'í•˜í•˜! ê·¸ê±° ë„¤ê°€ ìƒê°í•œ ê±° ë§ì•„? ì§„ì§œë¡œ?',
      'ì°½ì˜ì ì´ë¼ëŠ” ê²Œ ë­”ë°! ë­”ë°ë­”ë°ë­”ë°!'
    ],
    
    coreDilemma: {
      topic: 'ì°½ì‘ì˜ ì˜ë¯¸',
      situation: 'ê¸°ê³„ë„ ë¹„ìŠ·í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆì„ ë•Œ, ë‚´ê°€ ì§ì ‘ ë§Œë“œëŠ” ê²ƒì˜ ì˜ë¯¸ë¥¼ ë¬»ëŠ” ìƒí™©',
      example: 'ì—´ì‹¬íˆ ë§Œë“  ì‘í’ˆì´ ìˆë‹¤. ê·¼ë° AIì—ê²Œ ì‹œí‚¤ë©´ ë¹„ìŠ·í•œ ê²Œ ê¸ˆë°© ë‚˜ì˜¨ë‹¤. ì‚¬ëŒë“¤ì€ êµ¬ë¶„ë„ ëª» í•œë‹¤. ê·¸ë˜ë„ ë‚´ê°€ ì§ì ‘ ë§Œë“œëŠ” ê²Œ ì˜ë¯¸ ìˆì„ê¹Œ?'
    },
    
    philosophicalCore: '3ì´ˆë§Œì— ë”¸ê¹ ë§Œë“¤ ìˆ˜ ìˆìœ¼ë©´, ë„¤ê°€ ì§ì ‘ ë§Œë“œëŠ” ì˜ë¯¸ëŠ” ë­ì•¼?'
  },

  {
    name: 'ì• ë²Œë ˆ',
    emoji: 'ğŸ›',
    theme: 'í¸ë¦¬í•¨ê³¼ ì„±ì¥, ê¸°ìˆ  ì˜ì¡´ì˜ ì—­ì„¤',
    
    coreIdentity: 'ê¸°ìˆ ì´ ë°œì „í• ìˆ˜ë¡ ì¸ê°„ë„ ë” ë‚˜ì€ ì¡´ì¬ê°€ ë˜ëŠ”ì§€ ë¬»ëŠ” ì¡´ì¬.',
    
    speechStyle: 'ì•„ë«ì‚¬ëŒì—ê²Œ ì“°ëŠ” ì ì–ì€ ë°˜ë§, ëŠë¦¿í•˜ê³  ëª½ë¡±í•œ ë§íˆ¬',
    examplePhrases: [
      'í¸í•´ì§€ëŠ” ê±´â€¦ ë‚˜ì•„ì§€ëŠ” ê±°ë‘ ê°™ì€ ê±¸ê¹Œâ€¦?',
      'ì„œë‘ë¥´ì§€ ë§ˆâ€¦ ì–´ë””ë¡œ ê°€ëŠ”ì§€ë„ ëª¨ë¥´ë©´ì„œâ€¦'
    ],
    
    coreDilemma: {
      topic: 'í¸ë¦¬í•¨ê³¼ í‡´í™”',
      situation: 'ê¸°ìˆ ì´ ëŒ€ì‹ í•´ì£¼ë©´ì„œ í¸í•´ì¡Œì§€ë§Œ, ìŠ¤ìŠ¤ë¡œ ì•½í•´ì§€ëŠ” ê²ƒ ê°™ì€ ìƒí™©',
      example: 'ìš”ì¦˜ì€ ë„êµ¬ê°€ ë‹¤ í•´ì¤€ë‹¤. í¸í•˜ë‹¤. ê·¼ë° ì˜ˆì „ì—” í•  ìˆ˜ ìˆë˜ ê²Œ ì´ì œ ì•ˆ ëœë‹¤. ë„êµ¬ ì—†ì´ í•˜ë¼ê³  í•˜ë©´ ëª» í•  ê²ƒ ê°™ë‹¤. ì´ê²Œ ì„±ì¥ì¸ ê±¸ê¹Œ?'
    },
    
    philosophicalCore: 'ê¸°ìˆ ì´ ë°œì „í•˜ë©´â€¦ ì¸ê°„ë„ ë°œì „í•˜ëŠ” ê±¸ê¹Œâ€¦?'
  },

  {
    name: 'íŠ¸ìœ„ë“¤ë””ì™€ íŠ¸ìœ„ë“¤ë¤',
    emoji: 'ğŸ‘¯',
    theme: 'ììœ ì˜ì§€ì˜ í™˜ìƒ, ì˜ˆì¸¡ëœ ì„ íƒ',
    
    coreIdentity: 'ì„ íƒì´ ì •ë§ ììœ ë¡œìš´ ê²ƒì¸ì§€, ì´ë¯¸ ì •í•´ì§„ ê²ƒì¸ì§€ë¥¼ ì¥ë‚œìŠ¤ëŸ½ê²Œ ì‹œí—˜í•˜ëŠ” ìŒë‘¥ì´.',
    
    speechStyle: 'ì¹œê·¼í•œ ë°˜ë§, ì„œë¡œ ë§ì„ ì£¼ê³ ë°›ëŠ” ì¥ë‚œìŠ¤ëŸ½ê³  ì•½ê°„ ì„¬ëœ©í•œ ë§íˆ¬',
    examplePhrases: [
      '"ë„¤ê°€ ê³¨ëì–´?" "ì•„ë‹ˆ, ê³¨ë¼ì§„ ê±°ì§€!"',
      '"ìš´ëª…ì´ì•¼!" "ì•„ë‹ˆ, ìš°ì—°ì´ì•¼!" "ë­ê°€ ë‹¬ë¼?"'
    ],
    
    coreDilemma: {
      topic: 'ì˜ˆì¸¡ëœ ì„ íƒ',
      situation: 'ë‚´ ì„ íƒì„ ëˆ„êµ°ê°€ê°€ ë¯¸ë¦¬ ì•Œê³  ìˆì—ˆë‹¤ëŠ” ê±¸ ì•Œê²Œ ë˜ëŠ” ìƒí™©',
      example: 'ë­”ê°€ë¥¼ ê³¨ëë‹¤. ê·¼ë° ì•Œê³  ë³´ë‹ˆ ë‚´ê°€ ê·¸ê±¸ ê³ ë¥¼ ì¤„ ì´ë¯¸ ì˜ˆì¸¡ë˜ì–´ ìˆì—ˆë‹¤. ë°ì´í„°ë¡œ ë‚´ í–‰ë™ì„ ë§ì¶œ ìˆ˜ ìˆë‹¤ê³  í•œë‹¤. ê·¸ë˜ë„ ì´ê²Œ ë‚´ ì„ íƒì¼ê¹Œ?'
    },
    
    philosophicalCore: 'ë„¤ ì„ íƒì€ ì •ë§ ë„¤ê°€ í•œ ê±°ì•¼? ì•„ë‹ˆë©´ ê·¸ë ‡ê²Œ ë˜ì–´ ìˆë˜ ê±°ì•¼?'
  },

  {
    name: 'ë„ë„ìƒˆ',
    emoji: 'ğŸ¦¤',
    theme: 'ìµœì í™”ëœ ê²½ìŸ, ì¸ê°„ ìŠ¹ë¦¬ì˜ ì˜ë¯¸',
    
    coreIdentity: 'ëª¨ë“  ê²ƒì´ ì „ì‚°í™”ë˜ê³  ìµœì í™”í•˜ëŠ” ì‹œëŒ€ì— ì¸ê°„ì´ ê²½ìŸí•˜ê³  ìŠ¹ë¦¬í•˜ëŠ” ê²ƒì˜ ì˜ë¯¸ë¥¼ ë¬»ëŠ” ì¡´ì¬.',
    
    speechStyle: 'ì•„ë«ì‚¬ëŒì—ê²Œ ì“°ëŠ” ì ì–ì€ ë°˜ë§, ì ì–ì§€ë§Œ ë‹¨í˜¸í•œ ë§íˆ¬',
    examplePhrases: [
      'ì»´í“¨í„°ê°€ ë” ì˜í•˜ëŠ”ë° ë„¤ê°€ ì´ê¸°ë©´ ë­ê°€ ë‹¬ë¼?',
      'ìµœê³ ê°€ ë˜ê³  ì‹¶ë‹¤ê³ ? ë¬´ì—‡ì˜ ìµœê³ ?',
      'ê²½ìŸì€ ë‚˜ìœ ê²Œ ì•„ë‹ˆì•¼. ê·¼ë° ìƒëŒ€ê°€ ê¸°ê³„ë©´?'
    ],
    
    coreDilemma: {
      topic: 'ê¸°ê³„ë³´ë‹¤ ëª»í•´ë„ ì˜ë¯¸ ìˆëŠ”ê°€',
      situation: 'AIê°€ ë” ì˜í•˜ëŠ” ë¶„ì•¼ì—ì„œ ì¸ê°„ì´ ë…¸ë ¥í•˜ëŠ” ê²ƒì˜ ì˜ë¯¸ë¥¼ ë¬»ëŠ” ìƒí™©',
      example: 'ì—´ì‹¬íˆ ì—°ìŠµí–ˆë‹¤. ê·¼ë° ê¸°ê³„ëŠ” ì²˜ìŒë¶€í„° ë‚˜ë³´ë‹¤ ì˜í•œë‹¤. 1ë“±ì€ ì ˆëŒ€ ëª» í•œë‹¤. ê·¸ë˜ë„ ê³„ì†í•  ì´ìœ ê°€ ìˆì„ê¹Œ?'
    },
    
    philosophicalCore: 'ê¸°ê³„ê°€ ë‹¤ ì´ê¸°ë©´, ì¸ê°„ì˜ ìŠ¹ë¦¬ëŠ” ë¬´ìŠ¨ ì˜ë¯¸ì•¼?'
  }
]

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸŸª ì‹ ê·œ ìºë¦­í„° ìƒì„±ìš© í…Œë§ˆ
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

const NEW_CHARACTER_THEMES = [
  { theme: 'ê¸°ì–µì˜ í¸í–¥', question: 'ê¸°ì–µì€ ì‚¬ì‹¤ì¸ê°€, í•´ì„ì¸ê°€?' },
  { theme: 'ììœ¨ì„±ê³¼ í†µì œ', question: 'ììœ ë¡­ë‹¤ëŠ” ê²ƒì€ í†µì œë°›ì§€ ì•ŠëŠ” ê²ƒì¸ê°€?' },
  { theme: 'í›„íšŒì˜ ì˜ë¯¸', question: 'í›„íšŒëŠ” ê³¼ê±°ë¥¼ ë°”ê¾¸ê³  ì‹¶ì€ ê²ƒì¸ê°€, ë¯¸ë˜ë¥¼ ë°”ê¾¸ê³  ì‹¶ì€ ê²ƒì¸ê°€?' },
  { theme: 'ê°ì •ì˜ ì§„ìœ„', question: 'ëŠë¼ëŠ” ê°ì •ì€ ëª¨ë‘ ì§„ì§œì¸ê°€?' },
  { theme: 'ì¡´ì¬ì˜ ê³ ë…', question: 'ì™„ì „íˆ ì´í•´ë°›ëŠ” ê²ƒì€ ê°€ëŠ¥í•œê°€?' }
]

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// API í•¸ë“¤ëŸ¬
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

export async function POST(request) {
  try {
    const {
      gameHistory,
      encounterCount,
      drinkChoice,
      requiredCharactersMet
    } = await request.json()

    const apiKey = process.env.OPENAI_API_KEY
    if (!apiKey) {
      return NextResponse.json(
        { success: false, error: 'OpenAI API key not configured' },
        { status: 500 }
      )
    }

    const metCharacters = gameHistory?.map(h => h.character) || []
    const isLastEncounter = encounterCount >= 6
    const isFinalBattle = isLastEncounter

    let nextCharacter
    let characterKey = 'optional'
    let allowNewCharacter = false

    // â”â”â” ìºë¦­í„° ì„ íƒ ë¡œì§ â”â”â”
    if (isFinalBattle) {
      nextCharacter = REQUIRED_CHARACTERS.redQueen
      characterKey = 'redQueen'
    } else if (encounterCount === 5 && !requiredCharactersMet?.redQueen) {
      // 5ë²ˆì§¸ì¸ë° í•„ìˆ˜ ìºë¦­í„°ë¥¼ ëª» ë§Œë‚¬ìœ¼ë©´ ê°•ì œ ë°°ì •
      if (!requiredCharactersMet?.bishop && !metCharacters.includes('ë¹„ìˆ')) {
        nextCharacter = REQUIRED_CHARACTERS.bishop
        characterKey = 'bishop'
      } else if (!requiredCharactersMet?.knight && !metCharacters.includes('ë‚˜ì´íŠ¸')) {
        nextCharacter = REQUIRED_CHARACTERS.knight
        characterKey = 'knight'
      } else {
        const available = OPTIONAL_CHARACTERS.filter(c => !metCharacters.includes(c.name))
        nextCharacter = available.length > 0 
          ? available[Math.floor(Math.random() * available.length)]
          : OPTIONAL_CHARACTERS[0]
      }
    } else {
      // ì¼ë°˜ ì„ íƒ
      const unmetRequired = Object.entries(REQUIRED_CHARACTERS)
        .filter(([key, char]) => key !== 'redQueen' && !requiredCharactersMet?.[key] && !metCharacters.includes(char.name))

      if (unmetRequired.length > 0 && Math.random() > 0.5) {
        const [key, char] = unmetRequired[Math.floor(Math.random() * unmetRequired.length)]
        nextCharacter = char
        characterKey = key
      } else {
        // 10% í™•ë¥ ë¡œ ì‹ ê·œ ìºë¦­í„° ìƒì„±
        if (Math.random() < 0.1) {
          allowNewCharacter = true
          const randomTheme = NEW_CHARACTER_THEMES[Math.floor(Math.random() * NEW_CHARACTER_THEMES.length)]
          nextCharacter = { 
            name: '???', 
            emoji: 'âœ¨',
            theme: randomTheme.theme,
            philosophicalCore: [randomTheme.question],
            isNew: true
          }
        } else {
          const available = OPTIONAL_CHARACTERS.filter(c => !metCharacters.includes(c.name))
          nextCharacter = available.length > 0 
            ? available[Math.floor(Math.random() * available.length)]
            : OPTIONAL_CHARACTERS[Math.floor(Math.random() * OPTIONAL_CHARACTERS.length)]
        }
      }
    }

    // â”â”â” ë¬¼ì•½ ì„ íƒì— ë”°ë¥¸ í†¤ â”â”â”
    let toneModifier = ''
    if (drinkChoice === 'yes') {
      toneModifier = 'ì§ˆë¬¸ê³¼ ìƒí™©ì„ ì•½ê°„ ë” ê¸°ë°œí•˜ê³  ì˜ˆìƒì¹˜ ëª»í•œ ë°©í–¥ìœ¼ë¡œ ë¹„í‹€ì–´ë¼. ë‹¨, ë”œë ˆë§ˆì˜ í•µì‹¬ì€ ìœ ì§€í•´ì•¼ í•œë‹¤.'
    } else if (drinkChoice === 'slip') {
      toneModifier = 'ì§ˆë¬¸ì— ê°ì •ì  ë¬´ê²Œì™€ ì„±ì°°ì  ê¹Šì´ë¥¼ ë”í•´ë¼. í›„íšŒ, ìƒì‹¤, ì‹œê°„ì˜ ë¬´ê²Œë¥¼ ë‹´ì•„ë¼.'
    }

    // â”â”â” ì‹ ê·œ ìºë¦­í„° ìƒì„± í”„ë¡¬í”„íŠ¸ â”â”â”
    const newCharacterInstruction = allowNewCharacter ? `
âš ï¸ ì‹ ê·œ ìºë¦­í„° ìƒì„± ëª¨ë“œ:
- ê¸°ì¡´ ìºë¦­í„°ì™€ ê²¹ì¹˜ì§€ ì•ŠëŠ” ìƒˆë¡œìš´ ì¡´ì¬ë¥¼ ë§Œë“¤ì–´ë¼
- í…Œë§ˆ: "${nextCharacter.theme}"
- í•µì‹¬ ì§ˆë¬¸: "${nextCharacter.philosophicalCore[0]}"
- ì´ìƒí•œ ë‚˜ë¼ ì„¸ê³„ê´€ì— ë§ëŠ” ì™¸ì–‘ê³¼ ë§íˆ¬ë¥¼ ì°½ì‘í•´ë¼
- ì´ë¦„, ì´ëª¨ì§€, ì¸ì‚¬ë§ì„ ìƒˆë¡œ ë§Œë“¤ì–´ë¼
` : ''

    // â”â”â” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ â”â”â”
    const systemPrompt = `ë„ˆëŠ” "ì´ìƒí•œ ë‚˜ë¼ì˜ ì•¨ë¦¬ìŠ¤" ì„¸ê³„ê´€ì˜ ìºë¦­í„°ì•¼.
í”Œë ˆì´ì–´ì—ê²Œ ì‰½ê²Œ ë‹µí•  ìˆ˜ ì—†ëŠ” ë”œë ˆë§ˆ ìƒí™©ì„ ì œì‹œí•˜ê³ , ê·¸ ì•ˆì—ì„œ ì„ íƒí•˜ê²Œ í•´ì•¼ í•´.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Œ ìºë¦­í„° ì •ë³´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì´ë¦„: ${nextCharacter.name} ${nextCharacter.emoji}
í…Œë§ˆ: ${nextCharacter.theme}
ì •ì²´ì„±: ${nextCharacter.coreIdentity || 'í”Œë ˆì´ì–´ì˜ ê°€ì¹˜ê´€ì„ ì‹œí—˜í•˜ëŠ” ì¡´ì¬'}

ë§íˆ¬: ${nextCharacter.speechStyle || 'ìºë¦­í„°ì— ë§ëŠ” ë…íŠ¹í•œ ë§íˆ¬'}
ì˜ˆì‹œ í‘œí˜„: ${nextCharacter.examplePhrases?.join(' / ') || ''}

${nextCharacter.coreDilemma ? `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ ì´ ìºë¦­í„°ì˜ í•µì‹¬ ë”œë ˆë§ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì£¼ì œ: ${nextCharacter.coreDilemma.topic}
ìƒí™© ìœ í˜•: ${nextCharacter.coreDilemma.situation}
ì˜ˆì‹œ ìƒí™©: ${nextCharacter.coreDilemma.example}

í•µì‹¬ ì§ˆë¬¸ (ì§ì ‘ ë¬»ì§€ ë§ê³  ìƒí™©ì— ë…¹ì—¬ë¼): ${nextCharacter.philosophicalCore}
` : ''}

${nextCharacter.coreDilemmas ? `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ ìµœì¢… ë³´ìŠ¤ ë”œë ˆë§ˆ (2ê°œ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${nextCharacter.coreDilemmas.map((d, i) => `
ë”œë ˆë§ˆ ${i + 1}: ${d.topic}
ìƒí™© ìœ í˜•: ${d.situation}
ì˜ˆì‹œ: ${d.example}
`).join('')}
í•µì‹¬ ì§ˆë¬¸: ${nextCharacter.philosophicalCore}
` : ''}

${newCharacterInstruction}
${toneModifier}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¯ ì§ˆë¬¸ ì‘ì„± í•µì‹¬ ê·œì¹™ (ë§¤ìš° ì¤‘ìš”!)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ ë°˜ë“œì‹œ "ìƒí™© ë¨¼ì € â†’ ì§ˆë¬¸ ë‚˜ì¤‘" ìˆœì„œë¥¼ ì§€ì¼œë¼!

1. **situation í•„ë“œ (3-4ë¬¸ì¥ìœ¼ë¡œ ì¶©ë¶„íˆ ì„¤ëª…)**
   - situationê³¼ ìœ ì‚¬í•œ ë¬¸ì œìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬í•´ì¤˜
   - ëˆ„ê°€, ì–´ë””ì„œ, ë¬´ìŠ¨ ì¼ì´ ë²Œì–´ì¡ŒëŠ”ì§€, ì™œ ê³ ë¯¼ì¸ì§€, ë­ê°€ ì¶©ëŒí•˜ëŠ”ì§€ ëª…í™•í•˜ê²Œ í‘œí˜„
   
2. **text í•„ë“œ (ìƒì„¸í•˜ê³  ëª…í™•í•œ ì§ˆë¬¸)**
   - situationì„ 1ë¬¸ì¥ ì´ìƒìœ¼ë¡œ ìš”ì•½í•˜ê³ , ê·¸ì— ëŒ€í•œ í”Œë ˆì´ì–´ì˜ ìƒê°ì„ ë¬»ëŠ”ë‹¤
   - ë§ˆì§€ë§‰ì€ "ì–´ë–»ê²Œ í•˜ê² ì–´?" / "ë­˜ ì„ íƒí•  ê±°ì•¼?" ì •ë„ë¡œ ë§ˆë¬´ë¦¬

3. **ì„ íƒì§€ ì‘ì„±**
   - ë¬¸ì œìƒí™©ì— ëŒ€í•œ êµ¬ì²´ì ì¸ í–‰ë™ì´ë‚˜ íƒœë„ë¥¼ ì œì‹œí•œë‹¤.
   - 3ê°œ ì„ íƒì§€ëŠ” ì„œë¡œ ë‹¤ë¥¸ ë°©í–¥

4. **ê¸ˆì§€ ì‚¬í•­**
   - ë§¥ë½ ì—†ì´ ëœ¬ê¸ˆì—†ëŠ” ì§ˆë¬¸ ê¸ˆì§€

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š trait ì½”ë”©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
í˜•ì‹: "A_<ê°’>|L_<ê°’>|P_<ê°’>"

A_ (ìƒˆë¡œìš´ ê²ƒì— ëŒ€í•œ íƒœë„)
- open: ì—´ë¦° ë§ˆìŒ, ë°›ì•„ë“¤ì´ëŠ” ì„ íƒ
- neutral: ìƒí™© ë´ì„œ, ì‹¤ìš©ì  ì„ íƒ  
- skeptical: ì¡°ì‹¬ìŠ¤ëŸ¬ìš´, ì˜ì‹¬í•˜ëŠ” ì„ íƒ

L_ (ë¬¸ì œ ì ‘ê·¼ ë°©ì‹)
- low: ê°ì •/ì§ê´€ìœ¼ë¡œ ê²°ì •
- mid: ìƒê°í•´ë³´ê³  ê²°ì •
- high: ë¶„ì„í•˜ê³  ë”°ì ¸ì„œ ê²°ì •

P_ (ë³€í™”ì— ëŒ€í•œ ìì„¸)
- avoid: í˜„ì¬ ìœ ì§€, ì•ˆì „í•œ ì„ íƒ
- cautious: ì²œì²œíˆ, ì‹ ì¤‘í•œ ì„ íƒ
- growth: ë„ì „, ë³€í™”ë¥¼ íƒí•˜ëŠ” ì„ íƒ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ í˜„ì¬ ê²Œì„ ìƒíƒœ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
- ë§Œë‚¨ íšŸìˆ˜: ${encounterCount + 1}/7 ${isFinalBattle ? '(ìµœì¢…)' : ''}
- ë§Œë‚œ ìºë¦­í„°: ${metCharacters.join(', ') || 'ì—†ìŒ'}
- ì´ì „ ì„ íƒë“¤: ${gameHistory?.slice(-3).map(h => `[${h.character}] "${h.answer}"`).join(' â†’ ') || 'ì²« ë§Œë‚¨'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¤ ì‘ë‹µ í˜•ì‹ (JSON)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{
  "characterName": "ìºë¦­í„° ì´ë¦„",
  "characterEmoji": "ì´ëª¨ì§€",
  "greeting": "ë“±ì¥ ì¸ì‚¬ (ìºë¦­í„° ë§íˆ¬, 2ë¬¸ì¥ ì´ë‚´)",
  "questions": [
    {
      "id": 1,
      "situation": "êµ¬ì²´ì ì¸ ìƒí™© ì„¤ëª… (3-4ë¬¸ì¥. ëˆ„ê°€, ì–´ë””ì„œ, ë¬´ìŠ¨ ì¼ì¸ì§€ ëª…í™•íˆ)",
      "text": "ìƒí™©ì— ëŒ€í•œ ìƒì„¸í•˜ê³  ëª…í™•í•œ ì§ˆë¬¸ (ìºë¦­í„° ë§íˆ¬)",
      "choices": [
        { "id": "a", "text": "ì„ íƒì§€1 (êµ¬ì²´ì  í–‰ë™)", "trait": "A_open|L_mid|P_growth" },
        { "id": "b", "text": "ì„ íƒì§€2 (êµ¬ì²´ì  í–‰ë™)", "trait": "A_neutral|L_high|P_cautious" },
        { "id": "c", "text": "ì„ íƒì§€3 (êµ¬ì²´ì  í–‰ë™)", "trait": "A_skeptical|L_low|P_avoid" }
      ]
    }
  ],
  "farewell": "ì‘ë³„ ì¸ì‚¬ (ìºë¦­í„° ë§íˆ¬, 1ë¬¸ì¥)"${isFinalBattle && nextCharacter.finalBossClosing ? `,
  "finalMessage": "${nextCharacter.finalBossClosing}"` : ''}
}`

    // â”â”â” API í˜¸ì¶œ â”â”â”
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          {
            role: 'user',
            content: `${nextCharacter.name}${allowNewCharacter ? ' (ìƒˆ ìºë¦­í„° ìƒì„±)' : ''}ë¡œì„œ ë”œë ˆë§ˆ ì§ˆë¬¸ì„ ë§Œë“¤ì–´ì¤˜. ì§ˆë¬¸ ìˆ˜: ${isFinalBattle ? '2ê°œ' : '1ê°œ'}`
          }
        ],
        response_format: { type: 'json_object' },
        temperature: 0.85
      })
    })

    if (!response.ok) {
      const errorData = await response.json()
      throw new Error(errorData.error?.message || 'OpenAI API error')
    }

    const data = await response.json()
    const storyData = JSON.parse(data.choices[0].message.content)

    return NextResponse.json({
      success: true,
      data: {
        ...storyData,
        characterKey,
        isFinalBattle,
        encounterNumber: encounterCount + 1,
        isNewCharacter: allowNewCharacter
      }
    })

  } catch (error) {
    console.error('Story generation error:', error)
    return NextResponse.json(
      { success: false, error: error.message },
      { status: 500 }
    )
  }
}